!function(e,r){if("object"==typeof exports&&"object"==typeof module)module.exports=r(require("long"),require("protobufjs/minimal"));else if("function"==typeof define&&define.amd)define(["long","protobufjs/minimal"],r);else{var t="object"==typeof exports?r(require("long"),require("protobufjs/minimal")):r(e.long,e["protobufjs/minimal"]);for(var n in t)("object"==typeof exports?exports:e)[n]=t[n]}}("undefined"!=typeof self?self:this,(function(e,r){return function(){"use strict";var t={1290:function(e,r,t){t.d(r,{RnN:function(){return i},v$W:function(){return n},zUi:function(){return o},zub:function(){return s}});var n="zc.crh.a.0",o="zc.hrh.smt.0",s="zc.hrh.smt.1",i="zc.hrh.grdbc"},4908:function(e,r,t){t.d(r,{Of:function(){return i},iJ:function(){return u},ns:function(){return c},pO:function(){return s}});var n=t(8627),o=t(5095),s={event:"/sdk/start_publish",error:{t:n.LLz,i:n.Q9p,u:n.xfZ,l:n.gSF,m:n.PA0,p:n.fzq,_:n.f43,v:n.qvY,k:n.S4u,O:n.SRE,j:n.Xxx,P:n.g9p,q:n.jZ$,S:n.$wo,D:n.SmZ,C:n.VU9,N:n.MrD,T:n.ZpF,J:n.iei,R:n.aa2,B:n.HCP,Z:n.dg1,F:n._68,U:n.kbF,A:n.kOd,W:n.WP4,$:n.JDv,K:n.Q3v,X:n.RBR,V:n.NCg,Y:n.xbZ,G:n.OdW,ee:n.sJH},urls:o.yp,is_center:o.yS,server_url:o.tK,publish_option:o.Gq,message:o.tK,stream_id:o.tK,stream_sid:o.Tr,room_id:o.tK,video_en_codec_id:o.Tr,cap_w:o.Tr,cap_h:o.Tr,w:o.Tr,h:o.Tr,video_en_fps:o.Tr,video_en_bps:o.Tr,audio_c_channel_count:o.Tr,audio_en_bps:o.Tr,aec_level:o.Tr,ans_level:o.Tr,agc:o.yS,traffic_control_min_video_bitrate:{bitrate:o.Tr,mode:o.Tr},enable_camera:o.yS,enable_mic:o.yS,video_activate:o.yS,audio_activate:o.yS,gw_version:o.Tr,use_na:o.Tr,is_dual_stream:o.Tr},i={event:"/sdk/publish_target",error:{re:n.ZEp,te:n.xU2,ne:n.S4u,oe:n.I7C,se:n.HO9,ie:n.aUw,ue:n.Oy0}},u={event:"/mss/pushadd",error:{re:n.ZEp},stream_id:o.tK,url:o.tK},c={event:"/mss/pushdel",error:{re:n.ZEp},stream_id:o.tK,url:o.tK}},5095:function(e,r,t){t.d(r,{Gq:function(){return n},Tr:function(){return i},tK:function(){return o},yS:function(){return u},yp:function(){return s}});var n=function(e){return e},o=function(e){return e},s=function(e){return e},i=function(e){return e},u=function(e){return e}},8627:function(e,r,t){t.d(r,{$wo:function(){return I},Arx:function(){return ve},B3d:function(){return me},Be2:function(){return ee},FB3:function(){return U},HCP:function(){return F},HO9:function(){return b},I4J:function(){return qe},I7C:function(){return Y},J79:function(){return c},JDv:function(){return te},JSm:function(){return re},L8E:function(){return R},LLz:function(){return y},MK1:function(){return ce},MrD:function(){return X},MuX:function(){return Pe},NCg:function(){return Te},OdW:function(){return Se},OrZ:function(){return E},Oy0:function(){return m},PA0:function(){return a},PTE:function(){return w},Q3v:function(){return ne},Q9p:function(){return l},RBR:function(){return se},RZs:function(){return je},RfS:function(){return Z},S4u:function(){return s},S5f:function(){return f},SB8:function(){return pe},SRE:function(){return H},SmZ:function(){return S},Tij:function(){return ze},VU9:function(){return D},WP4:function(){return K},XHx:function(){return be},Xxx:function(){return z},YDn:function(){return he},ZEp:function(){return d},ZpF:function(){return q},Zws:function(){return ge},_68:function(){return N},_HD:function(){return h},a$$:function(){return Ne},aUw:function(){return k},aa2:function(){return M},ann:function(){return ue},b1q:function(){return Oe},ckD:function(){return De},clM:function(){return i},d49:function(){return u},dXc:function(){return ye},dg1:function(){return x},dqB:function(){return ae},ekj:function(){return _e},f43:function(){return L},fzq:function(){return B},g9p:function(){return _},gHA:function(){return fe},gSF:function(){return p},hYx:function(){return xe},hje:function(){return le},iei:function(){return C},jZ$:function(){return T},kOd:function(){return $},kbF:function(){return W},lgu:function(){return ke},m6U:function(){return V},mrK:function(){return Q},pWJ:function(){return Ee},qvY:function(){return oe},rBJ:function(){return Ce},sJH:function(){return P},sVF:function(){return g},s_m:function(){return j},t85:function(){return J},wxm:function(){return de},xU2:function(){return A},xbZ:function(){return ie},xfZ:function(){return v},yK:function(){return O},zML:function(){return we},zs3:function(){return G}});var n=t(8866),o="the user cancels the stream request.",s={code:1000002,message:"not login room"},i={code:1000014,message:"stream ID is too long"},u={code:1000015,message:"streamID is empty"},c={code:1000016,message:"stream ID contains illegal characters"},a={code:1000017,message:n.Rl},f={code:1000018,message:n.qC},d={code:1100001,message:n.dO},l={code:1100002,message:"network timeout."},m={code:1100999,message:"unknown server error"},h={code:1101005,message:"signal hb fail"},g={code:1002014,msg:n.fT},p={code:1102017,message:"dispatch error"},_={code:1102018,message:"token expired"},b={code:1102021,message:"biz channel error."},v={code:1102022,message:"dispatch request timeout"},k={code:1102024,message:"invalid channel"},z={code:1003025,message:"stream is forbided by media server"},w={code:1003050,message:"extra info of publishing stream is null"},y={code:1103001,message:n.dO},E={code:1103002,message:"browser do not support"},O={code:1103010,message:"screen fail"},j={code:1103011,message:"enumerate devices fail"},P={code:1103019,message:"publish streams auth fail"},q={code:1103021,message:"session request fail"},S={code:1103022,message:"create offer error"},D={code:1103023,message:"setLocalDescription error"},x={code:1103024,message:"mediaDesc error"},C={code:1103025,message:"other side offer error"},N={code:1103026,message:"candidate error"},T={code:1103027,message:"server session closed"},M={code:1103028,message:"ice connection error"},I={code:1103030,message:"negotiation timeout"},J={code:1103042,message:"screen canceled"},R={code:1103043,message:"screen not support"},B={code:1103044,message:n.aw},L={code:1103099,message:"stream is not capturing"},Z={code:1103049,message:"repeated pull same stream"},F={code:1103050,message:"websocket disconnected"},H={code:1103051,message:"publisher retry timeout"},U={code:1103053,message:"https is required"},A={code:1103055,message:n.Wk},W={code:1103056,message:"publish is publishing"},$={code:1103058,message:"client ip changed"},K={code:1103059,message:"ttl over time"},X={code:1103060,message:"session request timeout"},Q={code:1103061,message:"get media fail"},V={code:1103062,message:"update stream info fail"},Y={code:1103063,message:"publish target no response"},G={code:1103064,message:"get device not allowed"},ee={code:1103065,message:"device is not readable"},re={code:1103066,message:"device does not meet constraints"},te={code:1103067,message:"update sdp time out"},ne={code:1103068,message:"update sdp fail"},oe={code:1103073,message:"video effect is starting, please operate after video effect is started"},se={code:1103078,message:"publish stream poor and net probe poor"},ie={code:1103089,message:o},ue={code:1104001,message:"input parm error"},ce={code:1104021,message:"session request fail"},ae={code:1104022,message:"create offer error"},fe={code:1104023,message:"setLocalDescription error"},de={code:1104024,message:"mediaDesc error"},le={code:1104025,message:"other side offer error"},me={code:1104026,message:"candidate error"},he={code:1104027,message:"server session closed"},ge={code:1104028,message:"ice connection error"},pe={code:1104029,message:"websocket disconnected"},_e={code:1104030,message:"negotiation timeout"},be={code:1104031,message:"player retry timeout"},ve={code:1104032,message:"player is playing"},ke={code:1104033,message:"client ip changed"},ze={code:1104034,message:"ttl is over time"},we={code:1104035,message:"reset session push"},ye={code:1104036,message:"session request timeout"},Ee={code:1104037,message:"probe time out"},Oe={code:1104038,message:"resource mode is not supported"},je={code:1104039,message:"play stream not found"},Pe={code:1104041,message:"stream quality poor and net probe poor"},qe={code:1104042,message:o},Se={code:1104043,message:"mini sdp error"},De={code:1104045,message:"play streams is out limit"},xe={code:1104046,message:"play streams auth fail"},Ce={code:1103052,message:"publisher cdn push error"},Ne={code:1000055,message:"cdn url is invalid"},Te={code:1103100,message:"background process is start, but not subscribe yet"}},8866:function(e,r,t){t.d(r,{Rl:function(){return l},Wk:function(){return d},aw:function(){return u},dO:function(){return c},fT:function(){return s},h2:function(){return f},l3:function(){return n},pt:function(){return i},qC:function(){return a},rV:function(){return o}});t(8627),t(6994);var n=Promise;function o(e,r){return Math.floor(Math.random()*(r-e+1))+e}var s="room not exist",i="device is not found",u="stream is not from zego",c="input param error",a="local stream wrong",f="no preview",d="publish stream no found",l="network is broken"},4872:function(e,r,t){function n(e){return"string"==typeof e}t.d(r,{QP:function(){return n}})},5960:function(e,r,t){var n=t(3788),o=n.Reader,s=n.Writer,i=n.util,u=n.roots.default||(n.roots.default={});u.proto_media=function(){var e={};return e.MediaServerCommonResponse=function(){function e(e){if(e)for(var r=Object.keys(e),t=0;t<r.length;++t)null!=e[r[t]]&&(this[r[t]]=e[r[t]])}return e.prototype.code=0,e.prototype.message="",e.create=function(r){return new e(r)},e.encode=function(e,r){return r||(r=s.create()),null!=e.code&&Object.hasOwnProperty.call(e,"code")&&r.uint32(8).uint32(e.code),null!=e.message&&Object.hasOwnProperty.call(e,"message")&&r.uint32(18).string(e.message),r},e.decode=function(e,r){e instanceof o||(e=o.create(e));for(var t=void 0===r?e.len:e.pos+r,n=new u.proto_media.MediaServerCommonResponse;e.pos<t;){var s=e.uint32();switch(s>>>3){case 1:n.code=e.uint32();break;case 2:n.message=e.string();break;default:e.skipType(7&s)}}return n},e}(),e.RelayPublishCdnRequest=function(){function e(e){if(e)for(var r=Object.keys(e),t=0;t<r.length;++t)null!=e[r[t]]&&(this[r[t]]=e[r[t]])}return e.prototype.request_seq=0,e.prototype.request_cmd=0,e.prototype.streamid="",e.prototype.cdn_server="",e.prototype.publish_timeout=0,e.prototype.request_seq_v2=i.Long?i.Long.fromBits(0,0,!0):0,e.create=function(r){return new e(r)},e.encode=function(e,r){return r||(r=s.create()),null!=e.request_seq&&Object.hasOwnProperty.call(e,"request_seq")&&r.uint32(8).uint32(e.request_seq),null!=e.request_cmd&&Object.hasOwnProperty.call(e,"request_cmd")&&r.uint32(16).int32(e.request_cmd),null!=e.streamid&&Object.hasOwnProperty.call(e,"streamid")&&r.uint32(26).string(e.streamid),null!=e.cdn_server&&Object.hasOwnProperty.call(e,"cdn_server")&&r.uint32(34).string(e.cdn_server),null!=e.publish_timeout&&Object.hasOwnProperty.call(e,"publish_timeout")&&r.uint32(40).uint32(e.publish_timeout),null!=e.request_seq_v2&&Object.hasOwnProperty.call(e,"request_seq_v2")&&r.uint32(48).uint64(e.request_seq_v2),r},e.decode=function(e,r){e instanceof o||(e=o.create(e));for(var t=void 0===r?e.len:e.pos+r,n=new u.proto_media.RelayPublishCdnRequest;e.pos<t;){var s=e.uint32();switch(s>>>3){case 1:n.request_seq=e.uint32();break;case 2:n.request_cmd=e.int32();break;case 3:n.streamid=e.string();break;case 4:n.cdn_server=e.string();break;case 5:n.publish_timeout=e.uint32();break;case 6:n.request_seq_v2=e.uint64();break;default:e.skipType(7&s)}}return n},e}(),e.RelayPublishCdnResponse=function(){function e(e){if(e)for(var r=Object.keys(e),t=0;t<r.length;++t)null!=e[r[t]]&&(this[r[t]]=e[r[t]])}return e.prototype.request_seq=0,e.prototype.response=null,e.prototype.request_seq_v2=i.Long?i.Long.fromBits(0,0,!0):0,e.create=function(r){return new e(r)},e.encode=function(e,r){return r||(r=s.create()),null!=e.request_seq&&Object.hasOwnProperty.call(e,"request_seq")&&r.uint32(8).uint32(e.request_seq),null!=e.response&&Object.hasOwnProperty.call(e,"response")&&u.proto_media.MediaServerCommonResponse.encode(e.response,r.uint32(18).fork()).ldelim(),null!=e.request_seq_v2&&Object.hasOwnProperty.call(e,"request_seq_v2")&&r.uint32(24).uint64(e.request_seq_v2),r},e.decode=function(e,r){e instanceof o||(e=o.create(e));for(var t=void 0===r?e.len:e.pos+r,n=new u.proto_media.RelayPublishCdnResponse;e.pos<t;){var s=e.uint32();switch(s>>>3){case 1:n.request_seq=e.uint32();break;case 2:n.response=u.proto_media.MediaServerCommonResponse.decode(e,e.uint32());break;case 3:n.request_seq_v2=e.uint64();break;default:e.skipType(7&s)}}return n},e}(),e}(),e.exports=u},6994:function(r){r.exports=e},3788:function(e){e.exports=r}},n={};function o(e){var r=n[e];if(void 0!==r)return r.exports;var s=n[e]={exports:{}};return t[e](s,s.exports,o),s.exports}o.d=function(e,r){for(var t in r)o.o(r,t)&&!o.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:r[t]})},o.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};o.r(s),o.d(s,{StreamCDN:function(){return y}});var i,u,c,a,f=o(8627),d=o(4908),l=o(4872),m=o(1290),h=o(8866),g=function(){function e(e,r){this.ce=e,this.ae=r,this.attempt=0,this.fe=.3,this.de=4.8,this.le=0,this.retryTimer=null,this.maxTimer=null,this.isOverTime=!1,this.RETRY_MAX_TIME=60}return e.prototype.setRetryRule=function(e){switch(this.le=e,e){case 1:this.fe=.3,this.de=32;break;case 0:this.fe=.3,this.de=4.8}},e.prototype.getRetryDelayByCount=function(e){var r;r=1===this.le?e+2:e<2?0:e;var t=Math.min(this.de,this.fe*Math.pow(2,r)),n=(0,h.rV)(0,1e3*t);return this.ce.info("".concat(m.RnN," ").concat(this.attempt," ").concat(t," ").concat(n)),n},e.prototype.initCallback=function(e,r){this.sucCallBack=e,this.failCallBack=r},e.prototype.startMaxTime=function(){var e,r=this;this.ce.info("".concat(m.zUi," ").concat(null===(e=this.requestInfo)||void 0===e?void 0:e.streamID," call")),this.maxTimer?this.ce.warn("".concat(m.zUi," max timer")):(this.maxTimer=setTimeout((function(){var e;r.ce.warn("".concat(m.zUi," ").concat(null===(e=r.requestInfo)||void 0===e?void 0:e.streamID," over max time ").concat(r.RETRY_MAX_TIME,"s, stop retry")),r.isOverTime=!0,r.requestFail(r._err)}),1e3*this.RETRY_MAX_TIME),this.ce.info("".concat(m.zUi," maxTimer=").concat(this.maxTimer)))},e.prototype.invalid=function(){this.clearRetryTimer(),this.attempt=0},e.prototype.clearRetryTimer=function(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)},e.prototype.requestFail=function(e){this.invalid(),this.stopMaxTime(),this.failCallBack&&(this.failCallBack(e),this.resetCallback())},e.prototype.stopMaxTime=function(){this.ce.info("".concat(m.zub," stop max timer")),this.maxTimer&&clearTimeout(this.maxTimer),this.maxTimer=null},e.prototype.resetCallback=function(){this.sucCallBack=void 0,this.failCallBack=void 0},e}(),p=(i=function(e,r){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t])},i(e,r)},function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function t(){this.constructor=e}i(e,r),e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}),_=function(e){function r(r,t,n){var o=e.call(this,r,t)||this;return o.ce=r,o.ae=t,o.me=n,o.RETRY_MAX_TIME=8,o}return p(r,e),r.prototype.initReqParams=function(e,r){this.streamId=e,this.cdnPushConfig=r},r.prototype.active=function(e){var r=this;if(void 0===e&&(e=!1),this.retryTimer)this.ce.warn("".concat(m.v$W," was actived, ignore"));else if(this.isOverTime)this.ce.warn("".concat(m.v$W," retry over time, stop retry"));else{var t=function(){r.clearRetryTimer(),r.me.sendCDNRequest(r.streamId,r.cdnPushConfig,(function(e,t){var n=e.body;r.invalid(),r.stopMaxTime(),r.sucCallBack&&(r.sucCallBack&&r.sucCallBack(n,t),r.resetCallback())}),(function(e){r._err=e;var t=e.status_code;r.isOverTime?r.requestFail(e):((429===t||t>=500&&t<600)&&r.setRetryRule(1),r.active())})),e||r.attempt++};if(e)t();else{var n=this.getRetryDelayByCount(this.attempt);this.retryTimer=setTimeout(t,n)}}},r}(g);u=o(5960).proto_media,c=o(3788),a=o(6994),c.util.Long=a,c.configure();var b,v=function(){function e(){}return e.prototype.encodeRelayPublishCdnReq=function(e){var r=u.RelayPublishCdnRequest.create(e);return u.RelayPublishCdnRequest.encode(r).finish()},e.prototype.decodeRelayPublishCdnRsp=function(e){var r=u.RelayPublishCdnResponse.decode(e);return r.request_seq_v2&&a.isLong(r.request_seq_v2)&&(r.request_seq_v2=r.request_seq_v2.toNumber()),r},e}();!function(e){e[e.I=0]="I",e[e.H=10]="H",e[e.M=100]="M",e[e.L=1e3]="L"}(b||(b={}));var k={},z={_sendCDNPublishByAccessHub:function(e,r,t,n){var o=this;this.mediaProtoBuf||(this.mediaProtoBuf=new v);var s=new _(this.logger,this.stateCenter,this);s.initReqParams(e,r);var i=function(e,r){try{var t=o.mediaProtoBuf.decodeRelayPublishCdnRsp(e);o.logger.info("zb.sh.pt rsp decode ".concat(JSON.stringify(t)));var n=(null==t?void 0:t.response)||{};return{code:n.code,msg:n.message}}catch(e){return{code:-1}}};s.initCallback((function(e,s){var u=i(e),c=u.code,a=u.msg;c&&0!=c?(o.logger.error("zb.sh.pt "+r.type+" error code: "+c+" "+a),n(5004===c?f.a$$:f.Oy0," cmd: ".concat(r.type," ").concat(c," ").concat(a))):(o.logger.info("zb.sh.pt "+r.type+" success"),t&&t({errorCode:0,extendedData:""}))}),(function(e){var t=e.status_code,s=e.body,u=e.code,c=e.msg,a=JSON.parse(JSON.stringify(d.Of.error.ue)),f="";if(u)a={code:u,msg:c},f=c;else if(200===t)o.logger.info("zb.sh.pt error: "),a=d.Of.error.ue,f="cmd: ".concat(r.type);else{var m="";if((0,l.QP)(s))m=s;else{var h=i(s);m=h.code+" "+h.msg}f="request media server fail, error: "+t+" "+m}o.logger.error("zb.sh.pt "+f),n&&n(a,f)})),s.startMaxTime(),s.active(!0)},sendCDNRequest:function(e,r,t,n){var o=this,s="addpush"===r.type?1:2,i={request_seq:this.stateCenter.cdnSeq++,request_cmd:s,streamid:e,cdn_server:r.pushUrl,request_seq_v2:this.stateCenter.cdnSeqV2++};this.logger.info("zb.sh.scpba "+JSON.stringify(i));var u=this.mediaProtoBuf.encodeRelayPublishCdnReq(i);this.sendHttpPBRequest({interfaceID:6,resID:this.stateCenter.appid+"/"+e},u,(function(e,r){o.logger.info("zb.sh.pt receive message "+(null==e?void 0:e.status_code)),t&&t(e,r)}),(function(e){n&&n(e)}),{timeout:4e3})},_publishTarget:function(e,r,t){this.logger.info("zb.sh.pt call");var n=e.streamID;this.stateCenter.testEnvironment&&(n="zegotest-"+this.stateCenter.appid+"-"+e.streamID),this._sendCDNPublishByAccessHub(n,e,r,t)}},w=function(){function e(e,r,t,n){this.ce=e,this.dataReport=r,this.he=t,this.ae=n,this.screenShotReady=!1}return Object.defineProperty(e.prototype,"ge",{get:function(){return this.ae.reporter},enumerable:!1,configurable:!0}),e.prototype.publishTarget=function(e){var r=this,t="";switch(e.type){case"addpush":t=d.iJ.event;break;case"delpush":case"clearpush":t=d.ns.event}var n=this.ge.createSpan(b.H,{key:d.pO.event,par:e.streamID},{key:""},t);return n.setAttributes({url:d.ns.url(e.pushUrl)}),new h.l3((function(t,o){var s=function(e,t){r.ce.error("zb.pt "+(t||e.message)),r.ge.setError(n,e,t),o({errorCode:e.code,extendedData:e.message+(t?" "+t:"")})};if(-1==["addpush","delpush","clearpush"].indexOf(e.type))return r.ce.error("zb.sh.pt cdn push type error"),void s(f.rBJ,"type error");if(e.streamID&&(0,l.QP)(e.streamID))if(e.pushUrl&&(0,l.QP)(e.pushUrl))if(r.ae.publishStreamList[e.streamID]){var i=r.he.getRoomByStreamID(e.streamID);if(i){i.streamHandler._publishTarget(e,(function(e){n.end(),t(e)}),s)}else s(d.Of.error.ne)}else s(d.Of.error.te);else s(d.Of.error.re,"push url error");else s(d.Of.error.re,"stream id type error")}))},e}(),y={type:"StreamCDN",install:function(e,r,t){for(var n in Object.defineProperty(r.prototype,"initStreamCDN",{value:function(){this.streamCDNModule=new w(this.logger,this.dataReport,this.streamCenter,this.stateCenter)},writable:!1}),k)Object.defineProperty(e.prototype,n,{value:k[n],writable:!1});for(var n in z)Object.defineProperty(t.prototype,n,{value:z[n],writable:!1})}};return s}()}));